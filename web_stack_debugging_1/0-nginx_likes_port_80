#!/usr/bin/env bash

# This script installs and configures Nginx to listen on port 80 for all IPv4 interfaces, 
# ensures the firewall allows traffic on port 80, and restarts Nginx to return an HTTP 200 
# response on port 80 after execution.

# Check if Nginx is installed
if ! command -v nginx &> /dev/null; then
    echo "Nginx is not installed. Installing Nginx..."
    apt update && apt install -y nginx
fi

# Ensure Nginx is enabled and started
echo "Ensuring Nginx is running..."
systemctl enable nginx
systemctl start nginx

# Modify Nginx config to listen on all interfaces (IPv4)
echo "Configuring Nginx to listen on port 80 for all IPs..."
sed -i 's/listen 80 default_server;/listen 0.0.0.0:80 default_server;/' /etc/nginx/sites-available/default

# Ensure firewall allows traffic on port 80
echo "Allowing port 80 through the firewall..."
ufw allow 80/tcp

# Restart Nginx to apply changes
echo "Restarting Nginx to apply changes..."
systemctl restart nginx

# Check if Nginx is listening on port 80
echo "Verifying if Nginx is listening on port 80..."
ss -tuln | grep ':80'

# Check if the Nginx server responds with HTTP 200
echo "Checking if Nginx returns a web page with HTTP 200 on port 80..."
curl -I 0:80 | grep "HTTP/1.1 200 OK"

echo "Nginx is now configured to listen on port 80 and should return HTTP 200."

